<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²è¡¨å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-maroon: #6b0039;
            --bg-gray: #f4f4f7;
            --border-color: #bbbbbb;
        }

        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-gray); padding: 15px; margin: 0; }
        
        /* æ§åˆ¶é¢æ¿ */
        .controls {
            background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; align-items: end;
        }
        
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 0.75rem; font-weight: bold; color: #666; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }
        
        .color-inputs { display: flex; gap: 4px; }
        .color-inputs input[type="text"] { flex: 2; text-transform: uppercase; }
        .color-inputs input[type="color"] { flex: 1; height: 38px; padding: 2px; }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; grid-column: 1 / -1; margin-top: 10px; }
        button { flex: 1; min-width: 90px; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .btn-add { background-color: #2e7d32; }
        .btn-export { background-color: #0277bd; }
        .btn-clear { background-color: #c62828; }

        /* èª²è¡¨å®¹å™¨ */
        .table-wrapper { 
            background: white; border-radius: 8px; overflow-x: auto; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* é¡¯ç¤ºç”¨çš„èª²è¡¨ (æœƒéš¨æ‰‹æ©Ÿå¯¬åº¦ç”¢ç”Ÿæ²è»¸) */
        #mainTableArea { 
            background: white; padding: 15px; min-width: 900px; 
        }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; }
        th, td { border: 1px solid var(--border-color); text-align: center; vertical-align: middle; position: relative; }
        
        th { background-color: var(--primary-maroon); color: white; height: 50px; }
        .time-col { background-color: var(--primary-maroon); color: white; width: 120px; }
        .time-slot { font-size: 0.7rem; display: block; color: #ffccbc; font-weight: normal; }

        .course-cell { height: 90px; padding: 5px; }
        .course-name { font-size: 1.05rem; font-weight: 900; margin-bottom: 3px; line-height: 1.2; }
        .info-text { font-size: 0.85rem; font-weight: bold; }
        
        .delete-btn {
            position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.1);
            color: #666; border: none; border-radius: 50%; width: 20px; height: 20px;
            cursor: pointer; display: none; align-items: center; justify-content: center; font-size: 12px;
        }
        td:hover .delete-btn { display: flex; }

        /* éš±è—çš„å…‹éš†å®¹å™¨ï¼šå°ˆé–€ç”¨ä¾†æˆªåœ–ï¼Œå¼·è¿«å¯¬åº¦å±•é–‹ */
        #hiddenClone {
            position: absolute; top: -9999px; left: -9999px; width: 1100px; background: white;
        }
    </style>
</head>
<body>

    <h2 style="color: var(--primary-maroon); text-align: center;">ğŸ“… èª²è¡¨è£½ä½œ</h2>

    <div class="controls">
        <div class="input-group">
            <label>èª²ç¨‹åç¨±</label>
            <input type="text" id="courseName" placeholder="èª²ç¨‹åç¨±">
        </div>
        <div class="input-group">
            <label>è€å¸«/æ•™å®¤</label>
            <input type="text" id="teacherInfo" placeholder="è€å¸« D205">
        </div>
        <div class="input-group">
            <label>æ˜ŸæœŸ</label>
            <select id="daySelect">
                <option value="1">é€±ä¸€</option><option value="2">é€±äºŒ</option>
                <option value="3">é€±ä¸‰</option><option value="4">é€±å››</option>
                <option value="5">é€±äº”</option>
            </select>
        </div>
        <div class="input-group">
            <label>ç¯€æ¬¡</label>
            <select id="periodSelect"></select>
        </div>
        <div class="input-group">
            <label>æ–‡å­—é¡è‰² (#ä»£ç¢¼)</label>
            <div class="color-inputs">
                <input type="text" id="hexInput" value="#000066" oninput="syncColor(this.value, 'picker')">
                <input type="color" id="colorPicker" value="#000066" oninput="syncColor(this.value, 'text')">
            </div>
        </div>
        <div class="btn-group">
            <button class="btn-add" onclick="addCourse()">ï¼‹ æ–°å¢</button>
            <button class="btn-export" onclick="exportToJPG()">ğŸ“¸ åŒ¯å‡ºå®Œæ•´åœ–ç‰‡</button>
            <button class="btn-clear" onclick="clearAll()">é‡è¨­</button>
        </div>
    </div>

    <div class="table-wrapper">
        <div id="mainTableArea">
            <table>
                <thead>
                    <tr>
                        <th style="width: 120px;">æ™‚é–“ï¼æ˜ŸæœŸ</th>
                        <th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const periods = [
            { n: "1", t: "08:10 ~ 09:00" }, { n: "2", t: "09:10 ~ 10:00" },
            { n: "3", t: "10:10 ~ 11:00" }, { n: "4", t: "11:10 ~ 12:00" },
            { n: "5", t: "13:30 ~ 14:20" }, { n: "6", t: "14:30 ~ 15:20" },
            { n: "7", t: "15:30 ~ 16:20" }, { n: "8", t: "16:30 ~ 17:20" },
            { n: "9", t: "17:30 ~ 18:20" }
        ];

        function syncColor(val, target) {
            if (target === 'picker' && /^#[0-9A-F]{6}$/i.test(val)) {
                document.getElementById('colorPicker').value = val;
            } else if (target === 'text') {
                document.getElementById('hexInput').value = val.toUpperCase();
            }
        }

        function init() {
            const tbody = document.getElementById('tableBody');
            const select = document.getElementById('periodSelect');
            periods.forEach(p => {
                select.innerHTML += `<option value="${p.n}">ç¬¬${p.n}ç¯€</option>`;
                let row = `<tr>
                    <td class="time-col">ç¬¬${p.n}ç¯€<span class="time-slot">${p.t}</span></td>
                    ${[1,2,3,4,5].map(d => `<td id="cell-${p.n}-${d}" class="course-cell"></td>`).join('')}
                </tr>`;
                tbody.innerHTML += row;
            });
            loadSavedData();
        }

        function addCourse() {
            const name = document.getElementById('courseName').value;
            const info = document.getElementById('teacherInfo').value;
            const day = document.getElementById('daySelect').value;
            const period = document.getElementById('periodSelect').value;
            const textColor = document.getElementById('hexInput').value;
            if(!name) return alert("è«‹è¼¸å…¥èª²ç¨‹åç¨±");
            const cellId = `cell-${period}-${day}`;
            const data = { name, info, textColor };
            renderCell(cellId, data);
            localStorage.setItem(cellId, JSON.stringify(data));
        }

        function renderCell(id, data) {
            const cell = document.getElementById(id);
            if(!cell) return;
            if(!data) { cell.innerHTML = ""; return; }
            cell.style.color = data.textColor;
            cell.innerHTML = `
                <button class="delete-btn" onclick="removeCourse('${id}')">âœ•</button>
                <div class="course-name">${data.name}</div>
                <div class="info-text">${data.info}</div>`;
        }

        function removeCourse(id) {
            renderCell(id, null);
            localStorage.removeItem(id);
        }

        function loadSavedData() {
            for(let i=0; i<localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('cell-')) renderCell(key, JSON.parse(localStorage.getItem(key)));
            }
        }

        function clearAll() {
            if(confirm("ç¢ºå®šé‡è¨­ï¼Ÿ")) { localStorage.clear(); location.reload(); }
        }

        // å¾¹åº•è§£æ±ºåˆ‡é‚Šå•é¡Œçš„åŒ¯å‡ºå‡½å¼
        function exportToJPG() {
            const originalArea = document.getElementById('mainTableArea');
            
            // 1. å»ºç«‹ä¸€å€‹è‡¨æ™‚å®¹å™¨
            const cloneDiv = originalArea.cloneNode(true);
            cloneDiv.id = "hiddenClone";
            
            // 2. ç§»é™¤å…‹éš†é«”ä¸­çš„æ‰€æœ‰åˆªé™¤æŒ‰éˆ•
            const deleteBtns = cloneDiv.querySelectorAll('.delete-btn');
            deleteBtns.forEach(btn => btn.remove());
            
            // 3. æŠŠå…‹éš†é«”åŠ å…¥åˆ° Body (ä½†åœ¨ç•«é¢å¤–)
            document.body.appendChild(cloneDiv);

            // 4. å°å…‹éš†é«”é€²è¡Œæˆªåœ–
            html2canvas(cloneDiv, {
                backgroundColor: "#ffffff",
                scale: 2,         // é«˜è§£æåº¦
                width: 1100,      // å¼·åˆ¶å¯¬åº¦ï¼Œç¢ºä¿é€±äº”ä¸è¢«åˆ‡æ‰
                height: cloneDiv.offsetHeight,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'My_Complete_Timetable.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                
                // 5. ç§»é™¤è‡¨æ™‚å®¹å™¨
                document.body.removeChild(cloneDiv);
            });
        }

        init();
    </script>
</body>

</html>

